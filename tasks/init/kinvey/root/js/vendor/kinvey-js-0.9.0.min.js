/*!
 * kinvey-js-0.9.0
 *
 * Copyright (c) 2012 Kinvey, Inc. All rights reserved.
 *
 * Licensed to Kinvey, Inc. under one or more contributor
 * license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership.  Kinvey, Inc. licenses this file to you under the
 * Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License.  You
 * may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
(function(undefined){var b=this,c;"undefined"!=typeof exports?c=exports:c=b.Kinvey={};var d=Object.defineProperty(function(){},"extend",{value:function(a,b){var c=a&&a.hasOwnProperty("constructor")?a.constructor:this,d=function(){c.apply(this,arguments)};d.prototype=function(a,b){return Object.getOwnPropertyNames(b).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))}),a}(Object.create(this.prototype),a||{});if(b)for(var e in b)d[e]=b[e];return Object.defineProperty(d,"extend",Object.getOwnPropertyDescriptor(this,"extend")),d}}),e=function(a,b){return(b||function(){}).bind(a)},f=null;c.API_VERSION=0,c.SDK_VERSION="0.1.0dev",c.getCurrentUser=function(){return f},c.init=function(a){if("undefined"==typeof a.appKey||null==a.appKey)throw new Error("appKey must be defined");if("undefined"==typeof a.appSecret||null==a.appSecret)throw new Error("appSecret must be defined");c.appKey=a.appKey,c.appSecret=a.appSecret,c.env=a.env||"HTML5"},c.ping=function(a,b){var d=c.Net.factory(c.Net.APPDATA_API,"");d.send(function(b){e(b,a)()},e({},b))},c.setCurrentUser=function(a){f=a},c.Net={APPDATA_API:"APPDATA",USER_API:"USER",RESOURCE_API:"RESOURCE",CREATE:"CREATE",READ:"READ",UPDATE:"UPDATE",DELETE:"DELETE",factory:function(a,b,d){return"node"===c.env.toLowerCase()&&"undefined"!=typeof c.Net.Node?new c.Net.Node(a,b,d):new c.Net.Http(a,b,d)}},c.Net.Http=d.extend({ENDPOINT:function(a){return{BASE:a,APPDATA:a+"/appdata",RESOURCE:a+"/resource",USER:a+"/user"}}("https://baas.kinvey.com"),METHOD:function(a){var b={},c=b[a.CREATE]="POST";return b[a.READ]="GET",b[a.UPDATE]="PUT",b[a.DELETE]="DELETE",b}(c.Net),data:null,headers:{Accept:"application/json, text/javascript","Content-Type":"application/json; charset=utf-8"},operation:c.Net.READ,query:null,constructor:function(a,b,d){if(null==a)throw new Error("API must not be null");switch(a){case c.Net.APPDATA_API:if(null==b)throw new Error("Collection must not be null");break;case c.Net.USER_API:break;default:throw new Error("API "+a+" is not supported")}this.api=a,this.collection=b,this.id=d},send:function(a,b){if(null===c.getCurrentUser()&&c.Net.USER_API!==this.api){c.User.init(e(this,function(){this._process(a,b)}),b);return}this._process(a,b)},setData:function(a){this.data=a},setOperation:function(a){if(null==this.METHOD[a])throw new Error("Operation "+a+" is not supported");this.operation=a},setQuery:function(a){if(a instanceof c.Query)this.query=a;else throw new Error("Query must be of instance Kinvey.Query")},_encode:function(a){return a instanceof Object&&(a=JSON.stringify(a)),encodeURIComponent(a)},_getAuth:function(){var a=c.getCurrentUser();return null!==a?a.getUsername()+":"+a.getPassword():c.appKey+":"+c.appSecret},_getUrl:function(){var a="";switch(this.api){case c.Net.APPDATA_API:a=this.ENDPOINT.APPDATA+"/"+c.appKey+"/"+this.collection,null!=this.id&&(a+="/"+this.id);break;case c.Net.USER_API:a=this.ENDPOINT.USER+"/"+c.appKey+"/",null!=this.id&&(a+=this.id)}if(null!=this.query){var b=[],d=this.query.toJSON();d.limit&&b.push("limit="+this._encode(d.limit)),d.skip&&b.push("skip="+this._encode(d.skip)),d.sort&&b.push("sort="+this._encode(d.sort)),d.query&&b.push("query="+this._encode(d.query)),a+="?"+b.join("&")}return a},_handleResponse:function(a,b,c,d){try{b=JSON.parse(b)}catch(e){}200<=a&&300>a||304===a?c(b):d(b)},_process:function(a,b){if("undefined"==typeof XMLHttpRequest)throw new Error("XMLHttpRequest is not supported");var c=new XMLHttpRequest;c.open(this.METHOD[this.operation],this._getUrl(),!0);for(var d in this.headers)c.setRequestHeader(d,this.headers[d]);c.setRequestHeader("Authorization","Basic "+btoa(this._getAuth()));var e=this;c.onerror=function(){b({error:"Error"})},c.onload=function(){e._handleResponse(this.status,this.responseText,a,b)};var f=this.data?JSON.stringify(this.data):null;c.send(f)}}),c.Entity=d.extend({API:c.Net.APPDATA_API,ATTR_ID:"_id",constructor:function(a,b){if(null==a)throw new Error("Collection must not be null");this.attr=b||{},this.collection=a},destroy:function(a,b){if(this.isNew()){e(this,a)();return}var d=c.Net.factory(this.API,this.collection,this.getId());d.setOperation(c.Net.DELETE),d.send(e(this,function(){e(this,a)()}),e(this,b))},get:function(a){if(null==a)throw new Error("Key must not be null");var b=this.attr[a];return null!=b?b:null},getId:function(){return this.get(this.ATTR_ID)},isNew:function(){return null===this.getId()},load:function(a,b,d){if(null==a)throw new Error("Id must not be null");var f=c.Net.factory(this.API,this.collection,a);f.send(e(this,function(a){this.attr=a,e(this,b)()}),e(this,d))},save:function(a,b){var d=this.isNew()?c.Net.CREATE:c.Net.UPDATE,f=c.Net.factory(this.API,this.collection,this.getId());f.setData(this.attr),f.setOperation(d),f.send(e(this,function(b){this.attr=b,e(this,a)()}),e(this,b))},setId:function(a){if(null==a)throw new Error("Id must not be null");this.set(this.ATTR_ID,a)},set:function(a,b){if(null==a)throw new Error("Key must not be null");this.attr[a]=b},toJSON:function(){return this.attr},unset:function(a){delete this.attr[a]}}),c.Collection=d.extend({API:c.Net.APPDATA_API,list:[],map:c.Entity,constructor:function(a,b){if(null==a)throw new Error("Name must not be null");if(!b||b instanceof c.Query)this.name=a,this.query=b;else throw new Error("Query must be an instanceof Kinvey.Query")},clear:function(a,b){b=e(this,b),this.list=[],this.fetch(e(this,function(){var c=e(this,function(){var d=this.list[0];d?d.destroy(e(this,function(){this.list.shift(),c()}),b):e(this,a)()});c()}),b)},count:function(a,b){var d=c.Net.factory(this.API,this.name,"_count");this.query&&d.setQuery(this.query),d.send(e(this,function(b){e(this,a)(b.count)}),e(this,b))},fetch:function(a,b){this.list=[];var d=c.Net.factory(this.API,this.name);this.query&&d.setQuery(this.query),d.send(e(this,function(b){b.forEach(e(this,function(a){this.list.push(new this.map(this.name,a))})),e(this,a)()}),e(this,b))}}),c.User=c.Entity.extend({API:c.Net.USER_API,ATTR_USERNAME:"username",ATTR_PASSWORD:"password",constructor:function(a){c.Entity.prototype.constructor.call(this,"",a)},destroy:function(a,b){if(!this.isLoggedIn){e(this,b)({error:"This request requires the master secret"});return}c.Entity.prototype.destroy.call(this,function(){this.logout(),e(this,a)()},e(this,b))},getPassword:function(){return this.get(this.ATTR_PASSWORD)},getUsername:function(){return this.get(this.ATTR_USERNAME)},login:function(a,b,d,f){var g=c.getCurrentUser();null!==g&&g.logout(),this.setUsername(a),this.setPassword(b);var h=c.Net.factory(this.API,this.collection,"login");h.setData(this.attr),h.setOperation(c.Net.CREATE),h.send(e(this,function(a){this.attr=a,this.setPassword(b),this._login(),e(this,d)()}),e(this,f))},logout:function(){this.isLoggedIn&&(c.setCurrentUser(null),this._deleteFromDisk(),this.isLoggedIn=!1)},save:function(a,b){if(!this.isLoggedIn){e(this,b)({error:"This request requires the master secret"});return}var d=this.getPassword();c.Entity.prototype.save.call(this,function(){this.setPassword(d),this._login(),e(this,a)()},b)},setPassword:function(a){if(null==a)throw new Error("Password must not be null");this.set(this.ATTR_PASSWORD,a)},setUsername:function(a){if(null==a)throw new Error("Username must not be null");this.set(this.ATTR_USERNAME,a)},_deleteFromDisk:function(){localStorage.removeItem(c.User.CACHE_TAG)},_login:function(){c.setCurrentUser(this),this._saveToDisk(),this.isLoggedIn=!0},_saveToDisk:function(){localStorage.setItem(c.User.CACHE_TAG,JSON.stringify(this))}},{CACHE_TAG:"Kinvey.currentUser",create:function(a,b,d,f){if(null==a||"function"==typeof a)d=a,f=b,a=b="";else if(null==b||"function"==typeof b)f=d,d=b,b="";var g=c.getCurrentUser();null!==g&&g.logout();var h=new c.User;return h.setUsername(a),h.setPassword(b),c.Entity.prototype.save.call(h,function(){this._login(),e(this,d)()},f),h},init:function(a,b){var d=c.getCurrentUser();if(null!==d)return e(d,a)(),d;var f=JSON.parse(localStorage.getItem(c.User.CACHE_TAG));return null!==f&&null!=f.username&&null!=f.password?(d=new c.User,d.login(f.username,f.password,a,b),d):c.User.create(a,b)}}),c.UserCollection=c.Collection.extend({API:c.Net.USER_API,map:c.User,constructor:function(a){c.Collection.prototype.constructor.call(this,"",a)},clear:function(){throw new Error("This request requires the master secret")}}),c.Query=d.extend({currentKey:null,constructor:function(a){this.builder=a||c.Query.factory()},all:function(a){if(a instanceof Array)return this._set(c.Query.ALL,a),this;throw new Error("Argument must be of type Array")},and:function(a){return this._set(c.Query.AND,a.builder,!0),this},equal:function(a){return this._set(c.Query.EQUAL,a),this},exist:function(a){return a="undefined"!=typeof a?!!a:!0,this._set(c.Query.EXIST,a),this},greaterThan:function(a){return this._set(c.Query.GREATER_THAN,a),this},greaterThanEqual:function(a){return this._set(c.Query.GREATER_THAN_EQUAL,a),this},in_:function(a){if(a instanceof Array)return this._set(c.Query.IN,a),this;throw new Error("Argument must be of type Array")},lessThan:function(a){return this._set(c.Query.LESS_THAN,a),this},lessThanEqual:function(a){return this._set(c.Query.LESS_THAN_EQUAL,a),this},nearSphere:function(a,b){if(a instanceof Array&&2===a.length)return this._set(c.Query.NEAR_SPHERE,{point:a,maxDistance:"undefined"!=typeof b?b:null}),this;throw new Error("Point must be of type Array[lng, lat]")},notEqual:function(a){return this._set(c.Query.NOT_EQUAL,a),this},notIn:function(a){if(a instanceof Array)return this._set(c.Query.NOT_IN,a),this;throw new Error("Argument must be of type Array")},on:function(a){return this.currentKey=a,this},or:function(a){return this._set(c.Query.OR,a.builder,!0),this},reset:function(){return this.builder.reset(),this},setLimit:function(a){return this.builder.setLimit(a),this},setSkip:function(a){return this.builder.setSkip(a),this},size:function(a){return this._set(c.Query.SIZE,a),this},sort:function(a){return null!==a&&(a=a||c.Query.ASC),this.builder.setSort(this.currentKey,a),this},toJSON:function(){return this.builder.toJSON()},withinBox:function(a){if(a instanceof Array&&2===a.length)return this._set(c.Query.WITHIN_BOX,a),this;throw new Error("Points must be of type Array[[lng, lat], [lng, lat]]")},withinCenterSphere:function(a,b){if(a instanceof Array&&2===a.length)return this._set(c.Query.WITHIN_CENTER_SPHERE,{center:a,radius:b}),this;throw new Error("Point must be of type Array[lng, lat]")},withinPolygon:function(a){if(a instanceof Array)return this._set(c.Query.WITHIN_POLYGON,a),this;throw new Error("Points must be of type Array[[lng, lat], ...]")},_set:function(a,b,c){if(null===this.currentKey&&!c)throw new Error("Key under condition must not be null");this.builder.addCondition(this.currentKey,a,b)}},{EQUAL:16,EXIST:17,LESS_THAN:18,LESS_THAN_EQUAL:19,GREATER_THAN:20,GREATER_THAN_EQUAL:21,NOT_EQUAL:22,NEAR_SPHERE:1024,WITHIN_BOX:1025,WITHIN_CENTER_SPHERE:1026,WITHIN_POLYGON:1027,MAX_DISTANCE:1028,IN:2048,NOT_IN:2049,AND:4096,OR:4097,ALL:8192,SIZE:8193,ASC:16384,DESC:16385,factory:function(){return new c.Query.MongoBuilder}}),c.Query.MongoBuilder=d.extend({limit:null,skip:null,sort:null,query:null,constructor:function(){},addCondition:function(a,b,d){switch(b){case c.Query.EQUAL:this._set(a,d);break;case c.Query.EXIST:this._set(a,{$exists:d});break;case c.Query.LESS_THAN:this._set(a,{$lt:d});break;case c.Query.LESS_THAN_EQUAL:this._set(a,{$lte:d});break;case c.Query.GREATER_THAN:this._set(a,{$gt:d});break;case c.Query.GREATER_THAN_EQUAL:this._set(a,{$gte:d});break;case c.Query.NOT_EQUAL:this._set(a,{$ne:d});break;case c.Query.NEAR_SPHERE:var e={$nearSphere:d.point};d.maxDistance&&(e.$maxDistance=d.maxDistance),this._set(a,e);break;case c.Query.WITHIN_BOX:this._set(a,{$within:{$box:d}});break;case c.Query.WITHIN_CENTER_SPHERE:this._set(a,{$within:{$centerSphere:[d.center,d.radius]}});break;case c.Query.WITHIN_POLYGON:this._set(a,{$within:{$polygon:d}});break;case c.Query.IN:this._set(a,{$in:d});break;case c.Query.NOT_IN:this._set(a,{$nin:d});break;case c.Query.AND:if(!(d instanceof c.Query.MongoBuilder))throw new Error("Query must be of type Kinvey.Query.Mongobuilder");this.query={$and:[this.query||{},d.query||{}]};break;case c.Query.OR:if(!(d instanceof c.Query.MongoBuilder))throw new Error("Query must be of type Kinvey.Query.Mongobuilder");this.query={$or:[this.query||{},d.query||{}]};break;case c.Query.ALL:this._set(a,{$all:d});break;case c.Query.SIZE:this._set(a,{$size:d});break;default:throw new Error("Condition "+b+" is not supported")}},reset:function(){this.query=null},setLimit:function(a){this.limit=a},setSkip:function(a){this.skip=a},setSort:function(a,b){if(null==b){this.sort=null;return}var d=c.Query.ASC===b?1:-1;this.sort={},this.sort[a]=d},toJSON:function(){var a={};return this.limit&&(a.limit=this.limit),this.skip&&(a.skip=this.skip),this.sort&&(a.sort=this.sort),this.query&&(a.query=this.query),a},_set:function(a,b){this.query||(this.query={});if(!(b instanceof Object)){this.query[a]=b;return}this.query[a]instanceof Object||(this.query[a]={});for(var c in b)this.query[a][c]=b[c]}})}).call(this)